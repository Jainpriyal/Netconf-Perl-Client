#
# $Id: ssh.pm,v 1.6.486.1 2009-08-13 16:41:49 kdickman Exp $
#
# Copyright (c) 2005-2012, Juniper Networks, Inc.
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are
# met:
#      1.      Redistributions of source code must retain the above
# copyright notice, this list of conditions and the following
# disclaimer.
#      2.      Redistributions in binary form must reproduce the above
# copyright notice, this list of conditions and the following disclaimer
# in the documentation and/or other materials provided with the
# distribution.
#      3.      The name of the copyright owner may not be used to
# endorse or promote products derived from this software without specific
# prior written permission.
# THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
# IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
# WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
# DISCLAIMED. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT,
# INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
# (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
# SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
# HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
# STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING
# IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
# POSSIBILITY OF SUCH DAMAGE.
#

# child of Access

package Net::Netconf::Access::ssh;

use Expect;
use Net::Netconf::Trace;
use Net::Netconf::Access;
use Net::Netconf::Constants;
use Carp;
use File::Which;

use vars qw(@ISA);
@ISA = qw(Net::Netconf::Access);

sub disconnect
{
    my ($self) = shift;
    $self->{'ssh_obj'}->hard_close();
}

sub start
{
    my($self) = @_;
    my $sshprog;

    # Get ssh port number if it exists
    my $rport = (getservbyname('ssh', 'tcp'))[2];
    $rport = Net::Netconf::Constants::NC_DEFAULT_PORT unless $self->{'server'}
    eq 'junoscript';

    $self->{'server'} = 'netconf' unless $self->{'server'};

    my $echostate = 'stty -echo;';
    if (exists($self->{'sshprog'})) {
        $sshprog = $self->{'sshprog'};
    } else {
        $sshprog = which('ssh');
        if (defined($sshprog) && ($sshprog ne '')) {
            chomp($sshprog);
        } else {
            croak "Could not find sshclient on the system";
        }
    }

    # This implementation assumes OpenSSH.
    my $command = $echostate . $sshprog . ' -l ' . 
                  $self->{'login'} . ' -p ' . $rport . 
                  ' -s ' . $self->{'hostname'} . 
                  ' ' . $self->{'server'};

    # Create the Expect object
    my $ssh = Expect->spawn($command); 
    # Turn off logging to stdout
    $ssh->log_stdout(0);
    $ssh->log_file($self->out);

    # Send our password or passphrase
    if ($ssh->expect(10, 'password:', 'Password:', '(yes/no)?', '-re', 'passphrase.*:')) {
	my $m_num = $ssh->match_number();
	 
        SWITCH: {
	      if (($m_num == 1) || ($m_num == 2) || ($m_num == 4)) {
	          print $ssh "$self->{'password'}\r"; 
                  last SWITCH;
	      }
	      if ($m_num == 3) {
                  # Host-key authenticity.
                  print $ssh "yes\r";
	          if ($ssh->expect(10, 'password:', 'Password:', '-re', 'passphrase.*:')) {
		      print $ssh "$self->{'password'}\r";
	          } 
	          # After the yes/no option, expect the line: 'Warning: 
	          # Permanently added <....> to the list of known hosts.' 
	          $ssh->expect(10, 'known hosts.'); 
	          last SWITCH;
	      }
	} # SWITCH      
    } 
    else {
	if ($ssh->expect(10, '-re', '<!(.*?)>')) {
	    # Things are good. Do nothing.
	} else {    
	    $self->{'seen_eof'} = 1;
	}
    }

    $self->{'ssh_obj'} = $ssh;
    $self;
}

sub send
{
# print "\n\n^^^^^^^^^^^inside ssh send method ^^^^^^^^^^^^^^\n\n";
    my ($self, $xml) = @_;
    my $ssh = $self->{'ssh_obj'};
    $xml .= ']]>]]>';
    print $ssh "$xml\r";
    1;
}

sub recv
{

# print "\n\n^^^^^^^^^^^inside ssh recv method ^^^^^^^^^^^^^^\n\n";
     my $self = shift;
    my $xml;
    my $ssh = $self->{'ssh_obj'};
    if ($ssh->expect(600, ']]>]]>')) {
        $xml = $ssh->before() . $ssh->match();
    } else {
        print "Failed to login to $self->{'hostname'}\n";
        $self->{'seen_eof'} = 1;
    }
    $xml =~ s/]]>]]>//g;
    $xml;
}

sub out
{
    my $self = @_;
    foreach $line (@_) {
        if ($line =~ /Permission\ denied/) {
          print "Login failed: Permission Denied\n";
          $self->{'ssh_obj'}->hard_close();
          $self->{'seen_eof'} = 1;
        }
    }
}

1;

__END__

=head1 NAME

Net::Netconf::Access::ssh

=head1 SYNOPSIS

The Net::Netconf::Access::ssh module is used internally to provide ssh access to
a Net::Netconf::Access instance.

=head1 DESCRIPTION

This is a subclass of Net::Netconf::Access class that manages an ssh connection
with the destination host. The underlying mechanics for managing the ssh
connection is based on OpenSSH.

=head1 CONSTRUCTOR

new($ARGS)

Please refer to the constructor of Net::Netconf::Access class.

=head1 SEE ALSO

=over 4

=item *

Expect.pm

=item *

Net::Netconf::Access

=item *

Net::Netconf::Manager

=item *

Net::Netconf::Device

=back

=head1 AUTHOR

Juniper Networks Perl Team, send bug reports, hints, tips and suggestions to
support@juniper.net.

=head1 COPYRIGHT

Copyright (c) 2005, Juniper Networks, Inc.
All rights reserved.
